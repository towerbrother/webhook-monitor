// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// PROJECT - Root aggregate for multi-tenancy
// ============================================================================
// Responsibility: Tenant boundary that owns all webhook endpoints and events
// Ownership: Owns WebhookEndpoint and Event
// Invariants:
//   - All child entities must belong to exactly one project
//   - projectKey is unique and used for API authentication
//
model Project {
  id         String   @id @default(cuid())
  name       String
  projectKey String   @unique // Secret key for API authentication
  createdAt  DateTime @default(now())

  endpoints WebhookEndpoint[]
  events    Event[]
}

// ============================================================================
// WEBHOOK ENDPOINT - Configured destination for receiving webhooks
// ============================================================================
// Responsibility: Defines WHERE webhooks are accepted (unique URL)
// Ownership: Owned by Project, owns Event
// Invariants:
//   - Must belong to exactly one project
//   - URL is globally unique and immutable
//
model WebhookEndpoint {
  id        String   @id @default(cuid())
  url       String   @unique // Unique identifier (e.g., "ep_abc123")
  name      String
  projectId String
  createdAt DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  events  Event[]

  @@index([projectId])
}

// ============================================================================
// EVENT - Immutable record of a received webhook
// ============================================================================
// Responsibility: Captures complete HTTP request data (headers, body, method)
// Ownership: Owned by WebhookEndpoint AND Project (double-scoped)
// Invariants:
//   - Must belong to exactly one endpoint and one project
//   - event.projectId MUST equal event.endpoint.projectId (enforced in app)
//   - Data is immutable once created (append-only log)
//   - idempotencyKey is unique per project (prevents duplicate events)
//
model Event {
  id             String   @id @default(cuid())
  endpointId     String
  projectId      String   // Denormalized for query performance
  idempotencyKey String?  // Optional key for deduplication (unique per project)
  method         String
  headers        Json
  body           Json?    // Nullable - webhooks may have empty body
  receivedAt     DateTime @default(now())

  endpoint WebhookEndpoint @relation(fields: [endpointId], references: [id], onDelete: Cascade)
  project  Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, idempotencyKey])
  @@index([projectId, endpointId])
}

// ============================================================================
// RELATIONSHIPS
// ============================================================================
// Project (1) ──< has many >── (N) WebhookEndpoint
//    │                               │
//    └─< has many >──────────< belongs to >── Event
//
// Cascade deletion:
//   - Delete Project → deletes WebhookEndpoints → deletes Events
//   - Delete WebhookEndpoint → deletes Events
